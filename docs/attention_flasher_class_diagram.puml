@startuml
' Attention Flasher - Class Diagram
' Generated for readability in IDE (PlantUML)

title Attention Flasher - Class Diagram

class Adafruit_NeoPixel {
}

class SpanCharacteristic {
  + setVal(val)
  + getVal()
  + getNewVal()
}

enum PatternType {
  PATTERN_IDLE
  PATTERN_RGB
  PATTERN_FLASH
  PATTERN_PING
  PATTERN_POLICE
}

class PatternEngine {
  - Adafruit_NeoPixel &strip
  - PatternType currentPattern
  - unsigned long startTime
  - uint8_t rgbR, rgbG, rgbB, rgbW
  - uint8_t rgbBrightness
  + begin()
  + startPattern(type)
  + stopPattern()
  + update()
  + setRgbColor(r,g,b,w)
  + setRgbBrightness(b)
  + getCurrentPattern()
}

class RGBLightService {
  - SpanCharacteristic* power
  - SpanCharacteristic* brightness
  - SpanCharacteristic* hue
  - SpanCharacteristic* saturation
  + update()
}

class FlashLightService {
  - SpanCharacteristic* power
  + update()
}

class PingLightService {
  - SpanCharacteristic* power
  + update()
}

class PoliceLightService {
  - SpanCharacteristic* power
  + update()
}

class HomeSpan {
  + begin(cat, name)
  + poll()
}

' Global objects
object "strip : Adafruit_NeoPixel" as strip_obj
object "patternEngine : PatternEngine*" as patternEngine_obj
object "rgbService : RGBLightService*" as rgbService_obj
object "flashService : FlashLightService*" as flashService_obj
object "pingService : PingLightService*" as pingService_obj
object "policeService : PoliceLightService*" as policeService_obj

' Relationships
PatternEngine *-- Adafruit_NeoPixel : uses
RGBLightService --> PatternEngine : uses `patternEngine`
FlashLightService --> PatternEngine : uses `patternEngine`
PingLightService --> PatternEngine : uses `patternEngine`
PoliceLightService --> PatternEngine : uses `patternEngine`

RGBLightService --> SpanCharacteristic : "power, brightness, hue, saturation"
FlashLightService --> SpanCharacteristic : "power"
PingLightService --> SpanCharacteristic : "power"
PoliceLightService --> SpanCharacteristic : "power"

' disableOtherServices utility
class disableOtherServices <<utility>> {
  + disableOtherServices(activePattern)
}
disableOtherServices ..> RGBLightService : toggles
disableOtherServices ..> FlashLightService : toggles
disableOtherServices ..> PingLightService : toggles
disableOtherServices ..> PoliceLightService : toggles

' Notes for quick reading
note right of PatternEngine
  - Handles rendering modes: RGB, FLASH, PING, POLICE
  - Stores current color & brightness
  - Provides set/get and update loop
end note

note left of RGBLightService
  - Converts HSV -> RGB
  - Calls patternEngine->startPattern(PATTERN_RGB)
end note

@enduml
